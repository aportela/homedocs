import{b as d,a as T}from"./QCardSection-D9IAel0T.js";import{Q as $,a as z}from"./use-timeout-f6zK2_pC.js";import{Q as C}from"./QSpinnerHourglass-BgEsDQI1.js";import{Q as R}from"./QBtn-DS5wVTGT.js";import{Q as D}from"./ClosePopup-luNe27os.js";import{a as F,b as G,k as E,a9 as L,l as k,R as N,v as u,n as y,h as r,p as x,w as n,ac as O,f as g,g as o,e as j,q as _,t as f,r as H,G as J,s as W,o as h}from"./index-B-UYWWpq.js";import{Q as K}from"./QInput-pN4J6sFa.js";import{u as X,a as Y}from"./api-CM3iwbFc.js";import{u as Z}from"./useFormUtils-Dvne9-JV.js";import{u as ee}from"./serverEnvironment-DKulyRMn.js";import{d as S,a as ae}from"./CustomErrorBanner.vue_vue_type_script_setup_true_lang-Cj3i-oR3.js";import{d as se,_ as re}from"./PasswordFieldCustomInput.vue_vue_type_script_setup_true_lang-q2uWuT6K.js";import{_ as oe,a as te,b as le}from"./GitHubButton.vue_vue_type_script_setup_true_lang-B2e99P-n.js";const ne={class:"q-mt-sm q-mb-md text-h4 text-weight-bolder"},ie={class:"text-color-secondary"},me={key:0},ke=F({__name:"LoginForm",props:{showExtraBottom:{type:Boolean,default:!0}},emits:["success"],setup(V,{emit:A}){const I=A,{t:i}=G(),{requiredFieldRule:w}=Z(),Q=ee(),M=X(),a=E({...S}),t=E({...se}),b=L("lastUsedEmail",null),p=b.get(),l=E({email:p||"",password:""}),m=k(null),c=k(null),P=()=>{t.email.hasErrors=!1,t.email.message=null,t.password.hasErrors=!1,t.password.message=null,m.value?.resetValidation(),c.value?.resetValidation()},q=async()=>{P();try{await m.value?.validate(),await c.value?.validate(),m.value?.hasError?m.value?.focus():c.value?.hasError?c.value?.focus():B()}catch(s){console.error("Validation error",s)}},B=()=>{l.email&&l.password?(Object.assign(a,S),a.ajaxRunning=!0,Y.auth.login(l.email,l.password).then(s=>{M.setAccessToken(s.data.accessToken.token,s.data.accessToken.expiresAtTimestamp),b.set(l.email),I("success",s.data)}).catch(s=>{if(a.ajaxErrors=!0,s.isAPIError)switch(a.ajaxAPIErrorDetails=s.customAPIErrorDetails,s.response.status){case 400:s.response.data.invalidOrMissingParams.find(function(e){return e==="email"})?(a.ajaxErrorMessage="API Error: missing email param",u().then(()=>{m.value?.focus()}).catch(e=>{console.error(e)})):s.response.data.invalidOrMissingParams.find(function(e){return e==="password"})?(a.ajaxErrorMessage="API Error: missing password param",u().then(()=>{c.value?.focus()}).catch(e=>{console.error(e)})):(a.ajaxErrorMessage="API Error: invalid/missing param",u().then(()=>{m.value?.focus()}).catch(e=>{console.error(e)}));break;case 404:t.email.hasErrors=!0,t.email.message="Email not registered",u().then(()=>{m.value?.focus()}).catch(e=>{console.error(e)});break;case 401:t.password.hasErrors=!0,t.password.message="Invalid password",u().then(()=>{c.value?.focus()}).catch(e=>{console.error(e)});break;default:a.ajaxErrorMessage="API Error: fatal error";break}else a.ajaxErrorMessage=`Uncaught exception: ${s}`,console.error(s)}).finally(()=>{a.ajaxRunning=!1})):console.error("Missing email|password values")};return N(()=>{u().then(()=>{p?c.value?.focus():m.value?.focus()}).catch(s=>{console.error(s)})}),(s,e)=>{const U=H("router-link");return h(),y("form",{onSubmit:W(q,["prevent","stop"]),autocorrect:"off",autocapitalize:"off",autocomplete:"off",spellcheck:"false"},[r(d,{class:"text-center"},{default:n(()=>[r(T,{square:"",size:"128px"},{default:n(()=>[...e[2]||(e[2]=[g("img",{src:"icons/favicon-128x128.png"},null,-1)])]),_:1}),O(s.$slots,"slogan",{},()=>[g("h4",ne,f(o(i)(o(p)?"Glad to see you again!":"Welcome aboard!")),1),g("div",ie,f(o(i)(o(p)?"Let's get back to organizing.":"Let's start organizing.")),1)])]),_:3}),r(d,null,{default:n(()=>[r(o(K),{dense:"",outlined:"",ref_key:"emailRef",ref:m,modelValue:l.email,"onUpdate:modelValue":e[0]||(e[0]=v=>l.email=v),type:"email",name:"email",label:o(i)("Email"),disable:a.ajaxRunning,rules:[o(w)],"lazy-rules":"",error:t.email.hasErrors,"error-message":t.email.message?o(i)(t.email.message):""},{prepend:n(()=>[r($,{name:"alternate_email"})]),_:1},8,["modelValue","label","disable","rules","error","error-message"]),r(re,{dense:"",outlined:"",ref_key:"passwordRef",ref:c,class:"q-mt-md",modelValue:l.password,"onUpdate:modelValue":e[1]||(e[1]=v=>l.password=v),name:"password",label:o(i)("Password"),disable:a.ajaxRunning,rules:[o(w)],"lazy-rules":"",error:t.password.hasErrors,"error-message":t.password.message?o(i)(t.password.message):""},null,8,["modelValue","label","disable","rules","error","error-message"])]),_:1}),r(d,null,{default:n(()=>[r(R,{color:"primary",size:"md",label:s.$t("Sign in"),"no-caps":"",class:"full-width",icon:"account_circle",disable:a.ajaxRunning||!(l.email&&l.password),loading:a.ajaxRunning,type:"submit"},{loading:n(()=>[r(C,{class:"on-left"}),_(" "+f(o(i)("Sign in")),1)]),_:1},8,["label","disable","loading"]),a.ajaxErrors&&a.ajaxErrorMessage?(h(),j(ae,{key:0,text:a.ajaxErrorMessage,"api-error":a.ajaxAPIErrorDetails,class:"q-mt-lg"},null,8,["text","api-error"])):x("",!0)]),_:1}),V.showExtraBottom?(h(),y("div",me,[o(Q).isSignUpAllowed?(h(),j(d,{key:0,class:"text-center q-pt-none"},{default:n(()=>[g("div",null,[_(f(o(i)("Don't have an account yet ?"))+" ",1),r(U,{to:{name:"register"},class:"main-app-text-link-hover"},{default:n(()=>[_(f(o(i)("Click here to sign up")),1)]),_:1})])]),_:1})):x("",!0),r(z,{class:"q-mb-sm"}),r(d,{class:"text-center q-py-none"},{default:n(()=>[r(D,{flat:"",square:""},{default:n(()=>[r(oe),r(te),r(le,{label:"@2025 HomeDocs",href:o(J)},null,8,["href"])]),_:1})]),_:1})])):x("",!0)],32)}}});export{ke as _};
